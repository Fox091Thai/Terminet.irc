<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Terminet IRC - Chat</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: black;
            color: #e5ae73;
            font: 1.3rem Inconsolata, monospace;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: black;
            border-right: 2px solid #e5ae73;
            display: flex;
            flex-direction: column;
        }

        .logo-small {
            font-size: 20px;
            font-weight: bold;
            font-style: italic;
            text-align: center;
            padding: 15px;
            border-bottom: 1px solid #e5ae73;
            letter-spacing: 2px;
        }

        .tagline {
            font-size: 16px;
            text-align: center;
            padding: 5px;
            border-bottom: 1px solid #e5ae73;
            font-style: italic;
            color: #e5ae73;
        }

        .user-info {
            padding: 10px;
            border-bottom: 1px solid #e5ae73;
            text-align: center;
            font-size: 12px;
        }

        .servers-section {
            flex: 1;
            overflow-y: auto;
        }

        .servers-header {
            padding: 10px;
            background: #e5ae73;
            color: black;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }

        .room-item {
            font-size: 16px;
        }

        .room-item:hover {
            background: #ffd59b;
            color: #e5ae73;
        }

        /* Room items - selected state */
        .room-item.active {
            background: #ffe2c3;
            color: black;
            border-color: #e5ae73;
        }

        .server-item {
            background: #e5ae73;
            color: black;
            margin: 5px;
            padding: 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .server-item:hover {
            background: #d19960;
        }

        .server-item.active {
            background: #c08850;
        }

        .server-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 10px;
        }

        .action-btn {
            background: transparent;
            color: black;
            border: 1px solid black;
            padding: 2px 5px;
            margin-left: 2px;
            cursor: pointer;
            font-size: 9px;
        }

        .action-btn:hover {
            background: black;
            color: #e5ae73;
        }

        .action-btn.leave {
            background: #ff6b00;
            border-color: #ff6b00;
            color: white;
        }

        .action-btn.leave:hover {
            background: #e55500;
        }

        .action-btn.delete {
            background: #ff4444;
            border-color: #ff4444;
            color: white;
        }

        .action-btn.delete:hover {
            background: #cc3333;
        }

        .room-item {
            background: transparent;
            color: #000000;
            margin: 2px 10px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 11px;
            border: 1px solid #000000;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .room-item:hover {
            background: #545454;
        }

        .room-item.active {
            background: #e5ae73;
            color: black;
        }

        .room-actions {
            position: absolute;
            top: 2px;
            right: 5px;
            font-size: 8px;
        }

        .sidebar-btn {
            background: #e5ae73;
            color: black;
            border: none;
            padding: 8px;
            margin: 5px;
            cursor: pointer;
            font: 1.3rem Inconsolata, monospace;
            font-size: 11px;
            font-weight: bold;
        }

        .sidebar-btn:hover {
            background: #d19960;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .chat-header {
            background: black;
            color: #e5ae73;
            padding: 10px 20px;
            border-bottom: 1px solid #e5ae73;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: #e5ae73;
            color: black;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font: 1.3rem Inconsolata, monospace;
            font-size: 10px;
            font-weight: bold;
        }

        .header-btn:hover {
            background: #d19960;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px 20px;
            background: black;
            font-size: 16px;
            line-height: 1.4;
            min-height: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .message {
            margin-bottom: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            hyphens: auto;
            word-break: break-word;
        }

        .message .timestamp {
            color: #888;
            font-size: 16px;
        }

        .message.system {
            color: #888;
            font-style: italic;
        }

        .message.private {
            color: #ff6b9d;
        }

        .message .username {
            color: #e5ae73;
            font-weight: bold;
        }

        .embedded-content {
            margin: 2px 0;
            max-width: 100%;
            display: flex;
            justify-content: flex-start;
            overflow: hidden;
        }

        .embedded-content img,
        .embedded-content video {
            max-width: min(500px, 100%);
            max-height: 400px;
            height: auto;
            width: auto;
            border: 1px solid #e5ae73;
            object-fit: contain;
        }

        .embedded-content iframe {
            max-width: min(500px, 100%);
            width: 400px;
            height: 225px;
            border: 1px solid #e5ae73;
        }

        /* Custom HTML tags for messages */
        .message b,
        .message bold {
            font-weight: bold;
        }

        .message big {
            font-size: 1.2em;
        }

        .message center {
            display: block;
            text-align: center;
        }

        .message small {
            font-size: 0.8em;
        }

        .message blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        .message marquee {
            display: block;
            animation: marquee 10s linear infinite;
            white-space: nowrap;
            overflow: hidden;
        }

        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* Input Area */
        .input-container {
            display: flex;
            padding: 10px 20px;
            border-top: 1px solid #e5ae73;
            background: black;
            align-items: flex-end;
            gap: 10px;
            flex-shrink: 0;
            position: relative;
        }

        .message-input {
            flex: 1;
            background: black;
            color: #e5ae73;
            border: 1px solid #e5ae73;
            padding: 10px;
            font: 1.3rem Inconsolata, monospace;
            font-size: 13px;
            outline: none;
            resize: none;
            min-height: 40px;
            max-height: 160px;
            overflow-y: auto;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message-input::-webkit-scrollbar {
            width: 8px;
        }

        .message-input::-webkit-scrollbar-track {
            background: black;
        }

        .message-input::-webkit-scrollbar-thumb {
            background: #e5ae73;
        }

        .send-btn {
            background: #e5ae73;
            color: black;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font: 1.3rem Inconsolata, monospace;
            font-weight: bold;
            height: fit-content;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #d19960;
        }

        /* Users Panel */
        .users-panel {
            width: 200px;
            background: black;
            border-left: 2px solid #e5ae73;
            padding: 0;
        }

        .users-header {
            background: #e5ae73;
            color: black;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }

        .users-list {
            padding: 10px;
        }

        .user-item {
            padding: 5px;
            font-size: 12px;
            color: #e5ae73;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .user-item:hover {
            background: #333;
        }

        .kick-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 8px;
            margin-left: 5px;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #e5ae73;
            font-size: 11px;
            border-radius: 3px;
        }

        .connected {
            color: #4CAF50;
            border-color: #4CAF50;
        }

        .disconnected {
            color: #f44336;
            border-color: #f44336;
        }

        .connecting {
            color: #ff9800;
            border-color: #ff9800;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
        }

        .welcome-screen h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: black;
            margin: 15% auto;
            padding: 20px;
            border: 2px solid #e5ae73;
            width: 400px;
            max-width: 90%;
        }

        .modal h3 {
            margin-bottom: 15px;
            color: #e5ae73;
        }

        .modal input {
            width: 100%;
            background: black;
            color: #e5ae73;
            border: 1px solid #e5ae73;
            padding: 8px;
            margin: 5px 0;
            font: 1.3rem Inconsolata, monospace;
        }

        .modal-buttons {
            margin-top: 15px;
            text-align: right;
        }

        .modal-btn {
            background: #e5ae73;
            color: black;
            border: none;
            padding: 8px 16px;
            margin-left: 10px;
            cursor: pointer;
            font: 1.3rem Inconsolata, monospace;
            font-weight: bold;
        }

        .modal-btn.cancel {
            background: transparent;
            color: #e5ae73;
            border: 1px solid #e5ae73;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 4px;
            font: 1.3rem Inconsolata, monospace;
            font-size: 12px;
            z-index: 2000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: #4CAF50;
            color: white;
            border: 1px solid #4CAF50;
        }

        .notification.error {
            background: #f44336;
            color: white;
            border: 1px solid #f44336;
        }

        .debug-info {
            position: fixed;
            bottom: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #e5ae73;
            padding: 5px;
            font-size: 10px;
            color: #e5ae73;
            max-width: 300px;
            z-index: 1500;
        }

        .hidden {
            display: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: black;
        }

        ::-webkit-scrollbar-thumb {
            background: #e5ae73;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #d19960;
        }

        html::before {
            content: "";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background:
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 9999;
            pointer-events: none;
        }

        .input-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .upload-btn {
            background: #6a6a6a;
            color: white;
            border: none;
            padding: 0 15px;
            cursor: pointer;
            font: 1.3rem Inconsolata, monospace;
            font-weight: bold;
            height: 42px;
            flex-shrink: 0;
            align-self: flex-end;
        }

        .upload-btn:hover {
            background: #8a8a8a;
        }

        .file-input {
            display: none;
        }

        .upload-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: black;
            border: 2px solid #e5ae73;
            padding: 20px;
            z-index: 2000;
            min-width: 300px;
            text-align: center;
        }

        .upload-progress.hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border: 1px solid #e5ae73;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .message.file {
            color: #00bfff;
            border-left: 3px solid #00bfff;
            padding-left: 10px;
            background: rgba(0, 191, 255, 0.1);
        }

        .embedded-content audio {
            max-width: 100%;
            width: 400px;
        }

        .text-preview {
            background: #111;
            border: 1px solid #e5ae73;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            color: #ccc;
        }

        .file-download {
            display: inline-block;
            background: #e5ae73;
            color: black;
            padding: 5px 10px;
            text-decoration: none;
            border-radius: 3px;
            margin: 5px 0;
            font-size: 12px;
        }

        .file-download:hover {
            background: #d19960;
        }
    </style>
</head>

<body>
    <div class="debug-info" id="debug-info" style="display: none;">
        <div>Socket: <span id="socket-state">Not connected</span></div>
        <div>User ID: <span id="debug-user-id">-</span></div>
        <div>Server ID: <span id="debug-server-id">-</span></div>
        <div>Room ID: <span id="debug-room-id">-</span></div>
    </div>
    <div class="upload-progress hidden" id="upload-progress">
        <h3>Uploading File...</h3>
        <div id="upload-filename">filename.jpg</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div id="upload-percentage">0%</div>
    </div>
    <div class="sidebar">
        <div class="logo-small">TERMINET.IRC</div>
        <div class="tagline">if it works,it's a miracle</div>
        <div class="user-info">
            <div>User: <span id="current-username">Loading...</span></div>
            <div>@ <span id="current-room">#general</span></div>
        </div>

        <button class="sidebar-btn" onclick="showCreateServerModal()">+ Create Server</button>

        <div class="servers-section">
            <div class="servers-header">My Servers</div>
            <div id="servers-list">
                <div style="opacity: 0.5; font-size: 12px; padding: 10px; text-align: center;">Loading...</div>
            </div>
        </div>

        <button class="sidebar-btn" onclick="showJoinServerModal()">+ Join Server</button>
        <button class="sidebar-btn" onclick="showCreateRoomModal()" id="create-room-btn" style="display: none;">+ Create
            Room</button>
        <button class="sidebar-btn" onclick="logout()">Logout</button>
    </div>

    <div class="main-content">
        <div id="welcome-screen" class="welcome-screen">
            <h2>Welcome to:</h2>
            <div class="logo-small" style="font-size: 72px; font-style: italic; margin-bottom: 10px;">TERMINET.IRC</div>
            <p>Create or join a server to start chatting.</p>
            <br>
        </div>

        <div id="chat-container" style="display: none; flex-direction: column; height: 100%;">
            <div class="chat-header">
                <span id="chat-title">#general</span>
                <div class="header-actions">
                    <button class="header-btn" onclick="showNickModal()">Change Nick</button>
                    <button class="header-btn" onclick="loadRoomLogs()">Load Logs</button>
                    <span id="server-actions"></span>
                </div>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="input-container">
                <button class="upload-btn" onclick="triggerFileUpload()">&#x2191;</button>
                <textarea id="message-input" class="message-input" placeholder="Type message... (/help for commands)"
                    maxlength="1000" rows="1"></textarea>
                <button class="send-btn" onclick="sendMessage()">SEND</button>
                <input type="file" id="file-input" class="file-input" onchange="handleFileSelect(event)">
            </div>
        </div>
    </div>

    <div class="users-panel" id="users-panel" style="display: none;">
        <div class="users-header">Users Online</div>
        <div class="users-list" id="users-list"></div>
    </div>

    <div class="connection-status connecting" id="connection-status">
        <span id="status-text">Connecting...</span>
    </div>

    <div id="create-server-modal" class="modal">
        <div class="modal-content">
            <h3>Create Server</h3>
            <input type="text" id="server-name" placeholder="Server Name" maxlength="100">
            <input type="text" id="server-description" placeholder="Description (optional)" maxlength="200">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('create-server-modal')">Cancel</button>
                <button class="modal-btn" onclick="createServer()">Create</button>
            </div>
        </div>
    </div>

    <div id="join-server-modal" class="modal">
        <div class="modal-content">
            <h3>Join Server</h3>
            <input type="text" id="join-server-code" placeholder="Server Code" maxlength="8"
                style="text-transform: uppercase;">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('join-server-modal')">Cancel</button>
                <button class="modal-btn" onclick="joinServer()">Join</button>
            </div>
        </div>
    </div>

    <div id="create-room-modal" class="modal">
        <div class="modal-content">
            <h3>Create Room</h3>
            <input type="text" id="room-name" placeholder="Room Name" maxlength="50">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('create-room-modal')">Cancel</button>
                <button class="modal-btn" onclick="createRoom()">Create</button>
            </div>
        </div>
    </div>

    <div id="nick-modal" class="modal">
        <div class="modal-content">
            <h3>Change Nickname</h3>
            <input type="text" id="new-nickname" placeholder="New Nickname" maxlength="20">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('nick-modal')">Cancel</button>
                <button class="modal-btn" onclick="changeNickname()">Change</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-title">Confirm Action</h3>
            <p id="confirm-message">Are you sure?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('confirm-modal')">Cancel</button>
                <button class="modal-btn" id="confirm-action" onclick="">Confirm</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <script>
        let socket;
        let currentUser = null;
        let currentServer = null;
        let currentRoom = null;
        let isOwner = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let debugMode = false;

        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing...');
            const userData = sessionStorage.getItem('terminet_user');
            if (!userData) {
                console.log('No user data found, redirecting to login');
                window.location.href = '/';
                return;
            }

            currentUser = JSON.parse(userData);
            document.getElementById('current-username').textContent = currentUser.username;
            updateDebugInfo();

            checkServerHealth();

            setTimeout(() => {
                initializeSocket();
                setupInputHandlers();
            }, 500);
        });

        function setupInputHandlers() {
            const messageInput = document.getElementById('message-input');

            messageInput.addEventListener('input', function () {
                autoResizeTextarea(this);
            });

            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            document.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    const activeModal = document.querySelector('.modal[style*="block"]');
                    if (activeModal) {
                        const confirmBtn = activeModal.querySelector('.modal-btn:not(.cancel)');
                        if (confirmBtn) {
                            confirmBtn.click();
                        }
                    }
                }
            });
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        function checkServerHealth() {
            console.log('Checking server health...');
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    console.log('Health check response:', data);
                    document.getElementById('server-status').textContent = data.status;
                    document.getElementById('db-status').textContent = data.database;
                    document.getElementById('logs-status').textContent = data.storage;
                })
                .catch(error => {
                    console.error('Health check failed:', error);
                    document.getElementById('server-status').textContent = 'Error';
                    document.getElementById('db-status').textContent = 'Error';
                    document.getElementById('logs-status').textContent = 'Error';
                });
        }

        function updateDebugInfo() {
            if (debugMode) {
                document.getElementById('debug-user-id').textContent = currentUser?.user_id || '-';
                document.getElementById('debug-server-id').textContent = currentServer?.id || '-';
                document.getElementById('debug-room-id').textContent = currentRoom || '-';
                document.getElementById('socket-state').textContent = socket?.connected ? 'Connected' : 'Disconnected';
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugMode ? 'block' : 'none';
            if (debugMode) {
                updateDebugInfo();
            }
        }

        function initializeSocket() {
            console.log('Initializing socket connection...');
            updateConnectionStatus('connecting');

            if (socket) {
                socket.disconnect();
            }

            socket = io(window.location.origin, {
                transports: ['polling', 'websocket'],
                upgrade: true,
                timeout: 30000,
                forceNew: true,
                reconnection: true,
                reconnectionAttempts: maxReconnectAttempts,
                reconnectionDelay: 2000
            });

            socket.on('connect', function () {
                console.log('Socket connected successfully:', socket.id);
                updateConnectionStatus('connected');
                reconnectAttempts = 0;
                updateDebugInfo();
                setTimeout(loadUserServers, 500);
            });

            socket.on('disconnect', function (reason) {
                console.log('Socket disconnected:', reason);
                updateConnectionStatus('disconnected');
                updateDebugInfo();

                if (reason === 'io server disconnect') {
                    setTimeout(initializeSocket, 2000);
                }
            });

            socket.on('connect_error', function (error) {
                console.error('Socket connection error:', error);
                reconnectAttempts++;
                updateConnectionStatus('disconnected');

                if (reconnectAttempts >= maxReconnectAttempts) {
                    showNotification('Connection failed. Please refresh the page.', 'error');
                }
            });

            socket.on('connection_confirmed', function (data) {
                console.log('Connection confirmed:', data);
                showNotification('Connected to Terminet IRC', 'success');
            });

            socket.on('servers_list', function (data) {
                console.log('Received servers list:', data);
                renderServersList(data.owned_servers || [], data.joined_servers || []);
            });

            socket.on('server_created', function (data) {
                console.log('Server created:', data);
                if (data.success) {
                    showNotification('Server created successfully!', 'success');
                    closeModal('create-server-modal');
                    loadUserServers();
                } else {
                    showNotification('Failed to create server: ' + data.error, 'error');
                }
            });

            socket.on('server_joined', function (data) {
                console.log('Server joined:', data);
                if (data.success) {
                    showNotification('Joined server successfully!', 'success');
                    closeModal('join-server-modal');
                    loadUserServers();
                } else {
                    showNotification('Failed to join server: ' + data.error, 'error');
                }
            });

            socket.on('server_data', function (data) {
                console.log('Received server data:', data);
                if (data.success) {
                    currentServer = data.server;
                    isOwner = currentServer.owner_id === currentUser.user_id;
                    renderServerData(data.server, data.rooms);
                    updateDebugInfo();

                    const serverActions = document.getElementById('server-actions');
                    if (isOwner) {
                        serverActions.innerHTML = `
                <button class="header-btn" onclick="confirmDeleteServer(${currentServer.id}, '${currentServer.name}')">Delete Server</button>
            `;
                    } else {
                        serverActions.innerHTML = '';
                    }
                } else {
                    showNotification('Failed to load server: ' + data.error, 'error');
                }
            });

            socket.on('server_deleted', function (data) {
                console.log('Server deleted:', data);
                if (data.success) {
                    showNotification('Server deleted successfully', 'success');
                    if (currentServer && currentServer.id === data.server_id) {
                        currentServer = null;
                        currentRoom = null;
                        showWelcomeScreen();
                    }
                    loadUserServers();
                } else {
                    showNotification('Failed to delete server: ' + data.error, 'error');
                }
            });

            socket.on('server_left', function (data) {
                console.log('Server left:', data);
                if (data.success) {
                    showNotification('Successfully left server', 'success');
                    currentServer = null;
                    currentRoom = null;
                    showWelcomeScreen();
                    setTimeout(() => {
                        loadUserServers();
                    }, 500);
                } else {
                    showNotification('Failed to leave server: ' + data.error, 'error');
                }
            });

            socket.on('room_joined', function (data) {
                console.log('Room joined:', data);
                currentRoom = data.room_id;
                document.getElementById('current-room').textContent = '#' + data.room_name;
                document.getElementById('chat-title').textContent = '#' + data.room_name;
                updateDebugInfo();
                showChatContainer();
                renderMessages(data.messages || []);

                let isOwner = currentServer && currentServer.owner_id === currentUser.user_id;

                switch (data.is_locked) {
                    case 4:
                        updateInputState(false, "This channel is read-only");
                        break;
                    case 3:
                        updateInputState(isOwner, isOwner ? "Only you can type here" : "This channel is read-only");
                        break;
                    case 1: 
                        updateInputState(isOwner, isOwner ? "Channel is locked, but you can type" : "This channel is locked");
                        break;

                    case 0:
                    default:
                        updateInputState(true);
                        break;
                }
            });
            socket.on('room_created', function (data) {
                console.log('Room created:', data);
                if (data.success) {
                    showNotification('Room created successfully!', 'success');
                    closeModal('create-room-modal');
                    if (currentServer) {
                        loadServerData(currentServer.id);
                    }
                } else {
                    showNotification('Failed to create room: ' + data.error, 'error');
                }
            });

            socket.on('room_deleted', function (data) {
                console.log('Room deleted:', data);
                if (data.success) {
                    showNotification('Room deleted successfully', 'success');
                    if (currentServer) {
                        loadServerData(currentServer.id);
                    }
                } else {
                    showNotification('Failed to delete room: ' + data.error, 'error');
                }
            });

            socket.on('room_logs', function (data) {
                console.log('Room logs:', data);
                if (data.success) {
                    renderMessages(data.messages || []);
                    showNotification(`Loaded ${data.messages.length} messages from logs`, 'success');
                } else {
                    showNotification('Failed to load logs: ' + data.error, 'error');
                }
            });

            socket.on('new_message', function (data) {
                console.log('New message:', data);
                addMessage(data);
            });

            socket.on('system_message', function (data) {
                console.log('System message received:', data);
                addMessage(data);
            });

            socket.on('users_list', function (data) {
                console.log('Users list received:', data.users);
                renderUsersList(data.users || []);
            });

            socket.on('nickname_changed', function (data) {
                console.log('Nickname changed successfully:', data);
                if (data.success) {
                    currentUser.username = data.new_nick;
                    document.getElementById('current-username').textContent = data.new_nick;
                    sessionStorage.setItem('terminet_user', JSON.stringify(currentUser));
                    showNotification('Nickname changed successfully!', 'success');
                    closeModal('nick-modal');
                }
            });

            socket.on('nickname_error', function (data) {
                console.error('Nickname change error:', data);
                showNotification('Nickname change failed: ' + data.error, 'error');
            });

            socket.on('room_error', function (data) {
                console.error('Room error:', data);
                showNotification('Room error: ' + data.error, 'error');
            });

            socket.on('message_error', function (data) {
                console.error('Message error:', data);
                showNotification('Message error: ' + data.error, 'error');
            });

            socket.on('file_upload_error', function (data) {
                console.error('File upload error:', data);
                showNotification('File upload error: ' + data.error, 'error');
            });

            socket.on('error', function (error) {
                console.error('Socket error:', error);
                showNotification('Connection error occurred', 'error');
            });

          
            socket.on('kicked_from_server_reload', function (data) {
                console.log('Kicked from server with reload instruction:', data);
                showNotification(data.message, 'error');

                if (currentServer && currentServer.id === data.server_id) {
                    currentServer = null;
                    currentRoom = null;
                    alert(`${data.message}\n\nYou will be returned to the main screen.`);
                    showWelcomeScreen();
                }

                setTimeout(() => {
                    loadUserServers();
                }, 1000);
            });

            socket.on('kick_result', function (data) {
                console.log('Kick result:', data);
                if (data.success) {
                    showNotification(data.message, 'success');
                } else {
                    showNotification('Kick failed: ' + data.error, 'error');
                }
            });
            socket.on('channel_lock_status', function (data) {
                console.log('Channel lock status changed:', data);

                if (currentRoom === data.room_id) {
                    updateInputState(!data.locked || (currentServer && currentServer.owner_id === currentUser.user_id));
                    showNotification(data.message, data.locked ? 'error' : 'success');
                }
            });

            /**
 * Enables or disables the chat input area and updates its placeholder text.
 * @param {boolean} enabled - True to enable the input, false to disable.
 * @param {string} [message="Type message... (/help for commands)"] - The placeholder text to display.
 */
            function updateInputState(enabled, message = "Type message... (/help for commands)") {
                const messageInput = document.getElementById('message-input');
                const sendBtn = document.querySelector('.send-btn');
                const uploadBtn = document.querySelector('.upload-btn');

                if (enabled) {
                    messageInput.disabled = false;
                    messageInput.placeholder = message;
                    sendBtn.disabled = false;
                    uploadBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                    uploadBtn.style.opacity = '1';
                } else {
                    messageInput.disabled = true;
                    messageInput.placeholder = message;
                    sendBtn.disabled = true;
                    uploadBtn.disabled = true;
                    sendBtn.style.opacity = '0.5';
                    uploadBtn.style.opacity = '0.5';
                }
            }

            function joinRoom(roomId, roomName) {
                console.log('Joining room:', roomId, roomName);

                if (socket && socket.connected) {
                    socket.emit('join_room', {
                        room_id: roomId,
                        user_id: currentUser.user_id,
                        username: currentUser.username
                    });

                    if (roomName.toLowerCase() === 'welcome') {
                        updateInputState(false);
                    } else if (roomName.toLowerCase() === 'rules') {

                        updateInputState(currentServer && currentServer.owner_id === currentUser.user_id);
                    } else {

                        socket.emit('get_room_lock_status', {
                            room_id: roomId,
                            server_id: currentServer.id
                        });
                    }
                }
            }


            socket.on('room_lock_status', function (data) {
                if (data.success && data.room_id === currentRoom) {
                    updateInputState(!data.locked);
                }
            });



        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            const textEl = document.getElementById('status-text');

            statusEl.className = `connection-status ${status}`;

            switch (status) {
                case 'connected':
                    textEl.textContent = 'Connected';
                    break;
                case 'connecting':
                    textEl.textContent = 'Connecting...';
                    break;
                case 'disconnected':
                    textEl.textContent = 'Disconnected';
                    break;
            }
        }

        function loadUserServers() {
            console.log('Loading user servers...');
            if (socket && socket.connected && currentUser) {
                socket.emit('get_user_servers', {
                    user_id: currentUser.user_id
                });
            } else {
                console.error('Cannot load servers: socket not connected or no user');
            }
        }

        function loadRoomLogs() {
            if (!currentUser || !currentServer || !currentRoom) {
                showNotification('No room selected', 'error');
                return;
            }

            const logRequestData = {
                user_id: currentUser.user_id,
                server_id: currentServer.id,
                room_id: currentRoom,
                room_name: document.getElementById('chat-title').textContent.replace('#', ''),
                limit: 100
            };
            console.log('Loading room logs...');
            socket.emit('get_room_logs', logRequestData);
        }

        function renderServersList(ownedServers, joinedServers) {
            console.log('Rendering servers list:', ownedServers, joinedServers);
            const serversList = document.getElementById('servers-list');
            serversList.innerHTML = '';

            if (ownedServers.length === 0 && joinedServers.length === 0) {
                serversList.innerHTML = '<div style="opacity: 0.5; font-size: 12px; padding: 10px; text-align: center;">No servers found</div>';
                return;
            }

            ownedServers.forEach(server => {
                const serverEl = document.createElement('div');
                serverEl.className = 'server-item';
                serverEl.id = `server-item-${server.id}`;
                serverEl.innerHTML = `
                    <strong>${server.name}</strong><br>
                    <small>Code: ${server.code} (Owner)</small>
                    <div class="server-actions">
                        <button class="action-btn delete" onclick="event.stopPropagation(); confirmDeleteServer(${server.id}, '${server.name}')">DEL</button>
                    </div>
                `;
                serverEl.onclick = () => selectServer(server, serverEl);
                serversList.appendChild(serverEl);
            });

            joinedServers.forEach(server => {
                const serverEl = document.createElement('div');
                serverEl.className = 'server-item';
                serverEl.id = `server-item-${server.id}`;
                serverEl.innerHTML = `
                    <strong>${server.name}</strong><br>
                    <small>Code: ${server.code}</small>
                    <div class="server-actions">
                        <button class="action-btn leave" onclick="event.stopPropagation(); confirmLeaveServer(${server.id}, '${server.name}')">LEAVE</button>
                    </div>
                `;
                serverEl.onclick = () => selectServer(server, serverEl);
                serversList.appendChild(serverEl);
            });
        }

        function selectServer(server, element) {
            console.log('Selecting server:', server);
            document.querySelectorAll('.server-item').forEach(el => el.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            loadServerData(server.id);
        }

        function loadServerData(serverId) {
            console.log('Loading server data for:', serverId);
            if (socket && socket.connected) {
                socket.emit('get_server_data', {
                    server_id: serverId,
                    user_id: currentUser.user_id
                });
            }
        }

        function renderServerData(server, rooms) {
            console.log('Rendering server data:', server, rooms);
            const createRoomBtn = document.getElementById('create-room-btn');
            createRoomBtn.style.display = server.owner_id === currentUser.user_id ? 'block' : 'none';

            const activeServerEl = document.getElementById(`server-item-${server.id}`);
            if (!activeServerEl) return;

            const existingRooms = activeServerEl.querySelector('.rooms-container');
            if (existingRooms) existingRooms.remove();

            const roomsContainer = document.createElement('div');
            roomsContainer.className = 'rooms-container';
            roomsContainer.innerHTML = '<div style="padding: 5px 10px; font-weight: bold; font-size: 12px; color: #000000; border-top: 7px solid #666; margin-top: 10px;">Rooms:</div>';

            rooms.forEach(room => {
                const roomEl = document.createElement('div');
                roomEl.className = 'room-item';
                roomEl.id = `room-item-${room.id}`;

                let roomActions = '';
                if (server.owner_id === currentUser.user_id && !room.is_special) {
                    roomActions = `<div class="room-actions">
                <button class="action-btn delete" onclick="event.stopPropagation(); confirmDeleteRoom(${room.id}, '${room.name}')">DEL</button>
            </div>`;
                }

                let roomNameDisplay = room.name;
                if (room.is_special) {
                    roomNameDisplay = ` ${room.name}`;
                }

                roomEl.innerHTML = `#${roomNameDisplay}${roomActions}`;
                roomEl.onclick = () => {
                    document.querySelectorAll('.room-item').forEach(el => el.classList.remove('active'));
                    roomEl.classList.add('active');
                    joinRoom(room.id, room.name);
                };
                roomsContainer.appendChild(roomEl);
            });

            activeServerEl.appendChild(roomsContainer);
        }

        function joinRoom(roomId, roomName) {
            console.log('Joining room:', roomId, roomName);

            if (socket && socket.connected) {
                socket.emit('join_room', {
                    room_id: roomId,
                    user_id: currentUser.user_id,
                    username: currentUser.username
                });

                currentRoom = roomId;
                document.getElementById('current-room').textContent = '#' + roomName;
                document.getElementById('chat-title').textContent = '#' + roomName;
                updateDebugInfo();
            }
        }

        socket.on('room_joined', function (data) {
            console.log('Room joined:', data);
            currentRoom = data.room_id;
            document.getElementById('current-room').textContent = '#' + data.room_name;
            document.getElementById('chat-title').textContent = '#' + data.room_name;
            updateDebugInfo();
            showChatContainer();
            renderMessages(data.messages || []);

            if (data.is_locked === 2) { // Welcome room
                updateInputState(false);
            } else if (data.is_locked === 3) { // Rules room
                updateInputState(currentServer && currentServer.owner_id === currentUser.user_id);
            } else {
                updateInputState(data.is_locked !== 1 || (currentServer && currentServer.owner_id === currentUser.user_id));
            }
        });

        function renderServerData(server, rooms) {
            console.log('Rendering server data:', server, rooms);
            const createRoomBtn = document.getElementById('create-room-btn');
            createRoomBtn.style.display = server.owner_id === currentUser.user_id ? 'block' : 'none';

            const activeServerEl = document.getElementById(`server-item-${server.id}`);
            if (!activeServerEl) return;

            const existingRooms = activeServerEl.querySelector('.rooms-container');
            if (existingRooms) existingRooms.remove();

            const roomsContainer = document.createElement('div');
            roomsContainer.className = 'rooms-container';
            roomsContainer.innerHTML = '<div style="padding: 5px 10px; font-weight: bold; font-size: 12px; color: #000000; border-top: 7px solid #666; margin-top: 10px;">Rooms:</div>';

            rooms.forEach(room => {
                const roomEl = document.createElement('div');
                roomEl.className = 'room-item';
                roomEl.id = `room-item-${room.id}`;

                let roomActions = '';
                if (server.owner_id === currentUser.user_id && !room.is_special) {
                    roomActions = `<div class="room-actions">
                <button class="action-btn delete" onclick="event.stopPropagation(); confirmDeleteRoom(${room.id}, '${room.name}')">DEL</button>
            </div>`;
                }

                let roomNameDisplay = room.name;
                if (room.is_special) {
                    roomNameDisplay = ` ${room.name}`;
                }

                roomEl.innerHTML = `#${roomNameDisplay}${roomActions}`;
                roomEl.onclick = () => {
                    document.querySelectorAll('.room-item').forEach(el => el.classList.remove('active'));
                    roomEl.classList.add('active');
                    joinRoom(room.id, room.name);
                };
                roomsContainer.appendChild(roomEl);
            });

            activeServerEl.appendChild(roomsContainer);
        }

        function joinRoom(roomId, roomName) {
            console.log('Joining room:', roomId, roomName);

            if (socket && socket.connected) {
                socket.emit('join_room', {
                    room_id: roomId,
                    user_id: currentUser.user_id,
                    username: currentUser.username
                });

                currentRoom = roomId;
                document.getElementById('current-room').textContent = '#' + roomName;
                document.getElementById('chat-title').textContent = '#' + roomName;
                updateDebugInfo();

                if (roomName.toLowerCase() === 'welcome') {
                    updateInputState(false);
                } else if (roomName.toLowerCase() === 'rules') {

                    updateInputState(currentServer && currentServer.owner_id === currentUser.user_id);
                } else {
                    socket.emit('get_room_lock_status', {
                        room_id: roomId,
                        server_id: currentServer.id
                    });
                }
            }
        }

        function updateInputState(enabled, message = "Type message... (/help for commands)") {
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.querySelector('.send-btn');
            const uploadBtn = document.querySelector('.upload-btn');

            if (enabled) {
                messageInput.disabled = false;
                messageInput.placeholder = message;
                sendBtn.disabled = false;
                uploadBtn.disabled = false;
                sendBtn.style.opacity = '1';
                uploadBtn.style.opacity = '1';
            } else {
                messageInput.disabled = true;
                messageInput.placeholder = message;
                sendBtn.disabled = true;
                uploadBtn.disabled = true;
                sendBtn.style.opacity = '0.5';
                uploadBtn.style.opacity = '0.5';
            }
        }


        socket.on('server_data', function (data) {
            console.log('Received server data:', data);
            if (data.success) {
                currentServer = data.server;
                isOwner = currentServer.owner_id === currentUser.user_id;
                renderServerData(data.server, data.rooms);
                updateDebugInfo();

                const serverActions = document.getElementById('server-actions');
                if (isOwner) {
                    serverActions.innerHTML = `
                <button class="header-btn" onclick="lockCurrentChannel()">Lock Channel</button>
                <button class="header-btn" onclick="confirmDeleteServer(${currentServer.id}, '${currentServer.name}')">Delete Server</button>
            `;
                } else {
                    serverActions.innerHTML = '';
                }
            } else {
                showNotification('Failed to load server: ' + data.error, 'error');
            }
        });

        socket.on('room_joined', function (data) {
            console.log('Room joined:', data);
            renderMessages(data.messages || []);

            let isOwner = currentServer && currentServer.owner_id === currentUser.user_id;

            switch (data.is_locked) {
                case 4: 
                    updateInputState(false, "This channel is read-only");
                    break;
                case 3: 
                    updateInputState(isOwner, isOwner ? "Only you can type here" : "This channel is read-only");
                    break;
                case 1:
                    updateInputState(isOwner, isOwner ? "Channel is locked, but you can type" : "This channel is locked");
                    break;
                case 0: 
                default:
                    updateInputState(true);
                    break;
            }
        });

        function showChatContainer() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';
            document.getElementById('users-panel').style.display = 'block';
        }

        function showWelcomeScreen() {
            document.getElementById('welcome-screen').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('users-panel').style.display = 'none';
            document.getElementById('create-room-btn').style.display = 'none';
            document.querySelectorAll('.server-item').forEach(el => el.classList.remove('active'));
        }

        async function renderMessages(messages) {
            console.log('Rendering messages:', messages.length);
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            for (const msg of messages) {
                await addMessage(msg, false);
            }
            scrollToBottom();
        }

        async function addMessage(data, scroll = true) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${data.type}`;

            let content = '';
            if (data.type === 'system') {
                content = `<span class="timestamp">[${data.timestamp}]</span> <em>*** ${escapeHtml(data.message)}</em>`;
            } else if (data.type === 'private') {
                const processedMessage = await processMessage(data.message);
                content = `<span class="timestamp">[${data.timestamp}]</span> <span style="color: #ff6b9d;">[PRIVATE]</span> <span class="username">&lt;${data.username}&gt;</span> ${processedMessage}`;
            } else if (data.type === 'file_embed' && data.file_data) {
                const embedContent = await createFileEmbed(data.file_data);
                content = `<span class="timestamp">[${data.timestamp}]</span> <span class="username">&lt;${data.username}&gt;</span> ${embedContent}`;
            } else if (data.type === 'file' && data.download_url) {
                content = `<span class="timestamp">[${data.timestamp}]</span> <span class="username">&lt;${data.username}&gt;</span> <a href="${data.download_url}" class="file-download" target="_blank" download>${data.filename}</a>`;
            } else {
                const processedMessage = await processMessage(data.message);
                content = `<span class="timestamp">[${data.timestamp}]</span> <span class="username">&lt;${data.username}&gt;</span> ${processedMessage}`;
            }

            messageEl.innerHTML = content;
            messagesContainer.appendChild(messageEl);
            if (scroll) scrollToBottom();
        }

        async function processMessage(message) {
            let processedMsg = processHtmlTags(message);

            if (message.startsWith('/gif ') || message.startsWith('/img ')) {
                const url = message.substring(message.indexOf(' ')).trim();
                if (isValidImageUrl(url)) return `<div class="embedded-content"><img src="${url}" alt="Image" onerror="this.style.display='none'" loading="lazy"></div>`;
            }
            if (message.startsWith('/video ')) {
                const url = message.substring(7).trim();
                if (isYouTubeUrl(url)) {
                    const videoId = extractYouTubeId(url);
                    return `<div class="embedded-content"><iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe></div>`;
                } else if (isValidVideoUrl(url)) {
                    return `<div class="embedded-content"><video controls><source src="${url}"></video></div>`;
                }
            }

            const urlMatch = message.match(/https?:\/\/[^\s]+/g);
            if (urlMatch) {
                for (const url of urlMatch) {
                    let embed = '';
                    if (isValidImageUrl(url)) {
                        embed = `<div class="embedded-content"><img src="${url}" alt="Image" onerror="this.style.display='none'" loading="lazy"></div>`;
                    } else if (isYouTubeUrl(url)) {
                        const videoId = extractYouTubeId(url);
                        embed = `<div class="embedded-content"><iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe></div>`;
                    } else if (isValidVideoUrl(url)) {
                        embed = `<div class="embedded-content"><video controls><source src="${url}"></video></div>`;
                    }
                    if (embed) processedMsg = processedMsg.replace(url, `${url}${embed}`);
                }
            }
            return processedMsg;
        }

        function processHtmlTags(message) {
            const tempDiv = document.createElement('div');
            tempDiv.textContent = message;
            let processedMsg = tempDiv.innerHTML;

            processedMsg = processedMsg.replace(/&lt;size=(\d+)&gt;(.*?)&lt;\/size&gt;/gi, (_, size, content) => {
                const fontSize = Math.max(6, Math.min(48, parseInt(size) || 16));
                return `<span style="font-size: ${fontSize}px;">${content}</span>`;
            });
            const tags = ['b', 'bold', 'big', 'center', 'small', 'blink', 'marquee'];
            tags.forEach(tag => {
                const open = new RegExp(`&lt;${tag}&gt;`, 'gi');
                const close = new RegExp(`&lt;/${tag}&gt;`, 'gi');
                processedMsg = processedMsg.replace(open, `<${tag}>`).replace(close, `</${tag}>`);
            });
            return processedMsg;
        }



        function isValidImageUrl(url) { return /\.(jpeg|jpg|gif|png|webp|bmp|svg)$/i.test(url); }
        function isValidVideoUrl(url) { return /\.(mp4|webm|ogg|avi|mov)$/i.test(url); }
        function isYouTubeUrl(url) { return /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)/.test(url); }
        function extractYouTubeId(url) {
            const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            return match ? match[1] : '';
        }

        function renderUsersList(users) {
            console.log('Rendering users list:', users);
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';

            const uniqueUsers = [...new Set(users)].sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

            uniqueUsers.forEach(user => {
                const userEl = document.createElement('div');
                userEl.className = 'user-item';
                userEl.textContent = user;

                if (isOwner && user !== currentUser.username) {
                    const kickBtn = document.createElement('button');
                    kickBtn.className = 'kick-btn';
                    kickBtn.textContent = 'KICK';
                    kickBtn.onclick = () => kickUser(user);
                    userEl.appendChild(kickBtn);
                }
                usersList.appendChild(userEl);
            });
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            let message = input.value.trim();
            if (!message || !currentRoom) return;

            console.log('Sending message:', message);

            if (message.startsWith('/')) {
                if (handleCommand(message)) {
                    input.value = '';
                    autoResizeTextarea(input);
                    return;
                }
            }

            if (socket && socket.connected) {
                socket.emit('send_message', { message: message, user_id: currentUser.user_id, room_id: currentRoom, server_id: currentServer.id });
            } else {
                showNotification('Not connected to server', 'error');
            }
            input.value = '';
            autoResizeTextarea(input);
        }

        function handleCommand(message) {
            const parts = message.split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1).join(' ');

            switch (command) {
                case '/help':
                    showHelpMessage();
                    return true;
                case '/nick':
                    if (args) changeNicknameDirect(args);
                    else showNotification('Usage: /nick <new_nickname>', 'error');
                    return true;
                case '/logs':
                    loadRoomLogs();
                    return true;
                case '/clear':
                    document.getElementById('chat-messages').innerHTML = '';
                    return true;
                default:
                    return false;
                case '/lock':
                    if (currentServer && currentServer.owner_id === currentUser.user_id) {
                        lockChannel(true);
                    } else {
                        showNotification('Only server owners can lock channels', 'error');
                    }
                    return true;
                case '/unlock':
                    if (currentServer && currentServer.owner_id === currentUser.user_id) {
                        lockChannel(false);
                    } else {
                        showNotification('Only server owners can unlock channels', 'error');
                    }
                    return true;
                    function lockChannel(lock) {
                        if (!currentRoom) {
                            showNotification('No room selected', 'error');
                            return;
                        }

                        socket.emit('lock_channel', {
                            room_id: currentRoom,
                            server_id: currentServer.id,
                            user_id: currentUser.user_id,
                            lock: lock
                        });
                    }
            }
        }

        function showHelpMessage() {
            const helpText = `*** TERMINET IRC COMMANDS ***
/help - Show this help message
/nick <nickname> - Change your nickname
/gif <url> | /img <url> - Embed image/GIF
/video <url> - Embed video (YouTube supported)
/logs - Load recent room messages
/clear - Clear chat screen

*** FORMATTING TAGS (use < >) ***
b, bold, big, small, center, blink, marquee, size=12`;

            addMessage({
                type: 'system',
                message: helpText,
                timestamp: new Date().toLocaleTimeString().substring(0, 8)
            });
        }
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        function showModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
            modal.querySelectorAll('input').forEach(input => input.value = '');
        }
        function showCreateServerModal() { showModal('create-server-modal'); document.getElementById('server-name').focus(); }
        function showJoinServerModal() { showModal('join-server-modal'); document.getElementById('join-server-code').focus(); }
        function showCreateRoomModal() {
            if (!currentServer) return showNotification('Please select a server first', 'error');
            showModal('create-room-modal'); document.getElementById('room-name').focus();
        }
        function showNickModal() {
            const input = document.getElementById('new-nickname');
            input.value = currentUser.username;
            showModal('nick-modal');
            input.focus(); input.select();
        }

        function createServer() {
            const name = document.getElementById('server-name').value.trim();
            const description = document.getElementById('server-description').value.trim();
            if (!name) return showNotification('Server name is required', 'error');
            socket.emit('create_server', { name, description, owner_id: currentUser.user_id });
        }

        function joinServer() {
            const code = document.getElementById('join-server-code').value.trim().toUpperCase();
            if (!code) return showNotification('Server code is required', 'error');
            socket.emit('join_server', { server_code: code, user_id: currentUser.user_id, username: currentUser.username });
        }

        function createRoom() {
            const roomName = document.getElementById('room-name').value.trim();
            if (!roomName) return showNotification('Room name is required', 'error');
            if (!currentServer) return showNotification('No server selected', 'error');
            socket.emit('create_room', { room_name: roomName, server_id: currentServer.id, user_id: currentUser.user_id });
        }

        function changeNickname() {
            const newNick = document.getElementById('new-nickname').value.trim();
            if (!newNick) return showNotification('Nickname cannot be empty', 'error');
            changeNicknameDirect(newNick);
        }

        function changeNicknameDirect(newNickname) {
            if (newNickname === currentUser.username) return;
            if (newNickname.length > 20) return showNotification('Nickname must be 20 characters or less', 'error');
            if (socket && socket.connected && currentRoom) {
                socket.emit('change_nickname', { user_id: currentUser.user_id, new_nick: newNickname, room_id: currentRoom });
            }
        }

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-action').onclick = onConfirm;
            showModal('confirm-modal');
        }

        function confirmDeleteServer(serverId, serverName) { showConfirmModal('Delete Server', `Delete "${serverName}"? This is permanent.`, () => deleteServer(serverId)); }
        function confirmLeaveServer(serverId, serverName) { showConfirmModal('Leave Server', `Leave "${serverName}"?`, () => leaveServer(serverId)); }
        function confirmDeleteRoom(roomId, roomName) { showConfirmModal('Delete Room', `Delete "#${roomName}"?`, () => deleteRoom(roomId)); }

        function deleteServer(serverId) { socket.emit('delete_server', { server_id: serverId, user_id: currentUser.user_id }); closeModal('confirm-modal'); }
        function leaveServer(serverId) {
            socket.emit('leave_server', { server_id: serverId, user_id: currentUser.user_id, username: currentUser.username });
            closeModal('confirm-modal');
        }
        function deleteRoom(roomId) { socket.emit('delete_room', { room_id: roomId, user_id: currentUser.user_id }); closeModal('confirm-modal'); }

        function kickUser(username) {
            if (!isOwner) return showNotification('Only server owners can kick users', 'error');
            if (username === currentUser.username) return showNotification('You cannot kick yourself', 'error');
            showConfirmModal('Kick User', `Kick ${username} from this server? They will be permanently removed.`, () => {
                socket.emit('kick_user', { server_id: currentServer.id, username: username, kicked_by: currentUser.user_id });
                closeModal('confirm-modal');
            });
        }

        function showNotification(message, type = 'success') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function logout() {
            sessionStorage.removeItem('terminet_user');
            if (socket) socket.disconnect();
            window.location.href = '/';
        }

        window.addEventListener('beforeunload', () => { if (socket) socket.disconnect(); });
        window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) event.target.style.display = 'none'; });
        setInterval(() => { if (socket && !socket.connected) { initializeSocket(); } }, 10000);

        function triggerFileUpload() {
            if (!currentRoom) return showNotification('Please join a room to upload files', 'error');
            document.getElementById('file-input').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > (50 * 1024 * 1024)) return showNotification('File too large (Max 50MB)', 'error');
            uploadFile(file);
        }

        async function createFileEmbed(fileData) {
            const downloadUrl = fileData.download_url;
            const filename = fileData.filename;
            const fileType = fileData.file_type;

            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            switch (fileType) {
                case 'image':
                    return `<div class="embedded-content">
                        <img src="${downloadUrl}" alt="${filename}" loading="lazy"
                             style="max-width:100%; max-height:400px;">
                    </div>`;

                case 'video':
                    return `<div class="embedded-content">
                        <video controls style="max-width:100%; max-height:400px;">
                            <source src="${downloadUrl}">
                        </video>
                    </div>`;

                case 'audio':
                    return `<div class="embedded-content">
                        <audio controls style="width:100%;">
                            <source src="${downloadUrl}">
                        </audio>
                    </div>`;

                case 'text':
                    try {
                        const response = await fetch(downloadUrl);
                        if (!response.ok) throw new Error('Failed to load text');
                        const textContent = await response.text();
                        const truncated = textContent.length > 1000
                            ? textContent.substring(0, 1000) + '...'
                            : textContent;

                        return `<div class="text-preview">${escapeHtml(truncated)}</div>
                        <a href="${downloadUrl}" class="file-download" target="_blank">
                            Download ${escapeHtml(filename)}
                        </a>`;
                    } catch (e) {
                        return `<a href="${downloadUrl}" class="file-download" target="_blank">
                             ${escapeHtml(filename)}
                        </a>`;
                    }

                default:
                    return `<a href="${downloadUrl}" class="file-download" target="_blank">
                         ${escapeHtml(filename)}
                    </a>`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function uploadFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Please select a file to upload.', 'error');
                return;
            }
            if (!currentRoom || !currentUser || !currentServer) {
                showNotification('You must be in a room to upload files.', 'error');
                return;
            }
            if (file.size > (50 * 1024 * 1024)) { // 50MB client-side check
                return showNotification('File is too large (Max 50MB)', 'error');
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('user_id', currentUser.user_id);
            formData.append('room_id', currentRoom);
            formData.append('server_id', currentServer.id);

            const progressModal = document.getElementById('upload-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('upload-percentage');
            const filenameText = document.getElementById('upload-filename');

            filenameText.textContent = file.name;
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
            progressModal.classList.remove('hidden');

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    progressFill.style.width = percent + '%';
                    progressText.textContent = Math.round(percent) + '%';
                }
            };

            xhr.onload = () => {
                progressModal.classList.add('hidden');
                fileInput.value = '';

                if (xhr.status === 200) {
                    try {
                        const res = JSON.parse(xhr.responseText);
                        if (res.success && res.file_id) {
                            console.log(`HTTP upload success. Emitting 'file_uploaded' for file_id: ${res.file_id}`);

                            socket.emit('file_uploaded', {
                                file_id: res.file_id,
                                user_id: currentUser.user_id,
                                room_id: currentRoom,
                                server_id: currentServer.id
                            });

                            showNotification('File uploaded successfully!', 'success');
                        } else {
                            showNotification('Upload failed: ' + (res.error || 'Unknown server response'), 'error');
                        }
                    } catch (e) {
                        showNotification('Upload failed: Could not parse server response.', 'error');
                        console.error("Failed to parse upload response:", xhr.responseText);
                    }
                } else {
                    showNotification(`Upload failed: Server returned status ${xhr.status}`, 'error');
                }
            };

            xhr.onerror = () => {
                progressModal.classList.add('hidden');
                fileInput.value = '';
                showNotification('Upload failed due to a network error.', 'error');
            };

            xhr.send(formData);
        }
    </script>
</body>

</html>
