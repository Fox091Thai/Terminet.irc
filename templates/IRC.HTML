<!DOCTYPE html>
<html lang="en">
<link href='https://fonts.googleapis.com/css?family=Kanit' rel='stylesheet'>

<head>
    <meta charset="UTF-8">
    <title>Terminet IRC - Chat</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: black;
            color: #e5ae73;
            font-family: 'Kanit';
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: black;
            border-right: 2px solid #e5ae73;
            display: flex;
            flex-direction: column;
        }

        .logo-small {
            font-size: 20px;
            font-weight: bold;
            font-style: italic;
            text-align: center;
            padding: 15px;
            border-bottom: 1px solid #e5ae73;
            letter-spacing: 2px;
        }

        .tagline {
            font-size: 16px;
            text-align: center;
            padding: 5px;
            border-bottom: 1px solid #e5ae73;
            font-style: italic;
            color: #e5ae73;
        }

        .user-info {
            padding: 10px;
            border-bottom: 1px solid #e5ae73;
            text-align: center;
            font-size: 12px;
        }

        .servers-section {
            flex: 1;
            overflow-y: auto;
        }

        .servers-header {
            padding: 10px;
            background: #e5ae73;
            color: black;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }

        .server-item {
            background: #e5ae73;
            color: black;
            margin: 5px;
            padding: 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .server-item:hover {
            background: #d19960;
        }

        .server-item.active {
            background: #c08850;
        }

        .server-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 10px;
        }

        .action-btn {
            background: transparent;
            color: black;
            border: 1px solid black;
            padding: 2px 5px;
            margin-left: 2px;
            cursor: pointer;
            font-size: 9px;
        }

        .action-btn:hover {
            background: black;
            color: #e5ae73;
        }

        .action-btn.leave {
            background: #ff6b00;
            border-color: #ff6b00;
            color: white;
        }

        .action-btn.leave:hover {
            background: #e55500;
        }

        .action-btn.delete {
            background: #ff4444;
            border-color: #ff4444;
            color: white;
        }

        .action-btn.delete:hover {
            background: #cc3333;
        }

        .room-item {
            background: transparent;
            color: #e5ae73;
            margin: 2px 10px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 11px;
            border: 1px solid #666;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .room-item:hover {
            background: #333;
        }

        .room-item.active {
            background: #e5ae73;
            color: black;
        }

        .room-actions {
            position: absolute;
            top: 2px;
            right: 5px;
            font-size: 8px;
        }

        .sidebar-btn {
            background: #e5ae73;
            color: black;
            border: none;
            padding: 8px;
            margin: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
        }

        .sidebar-btn:hover {
            background: #d19960;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .chat-header {
            background: black;
            color: #e5ae73;
            padding: 10px 20px;
            border-bottom: 1px solid #e5ae73;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: #e5ae73;
            color: black;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            font-weight: bold;
        }

        .header-btn:hover {
            background: #d19960;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px 20px;
            background: black;
            font-size: 16px;
            line-height: 1.4;
            min-height: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .message {
            margin-bottom: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            hyphens: auto;
            word-break: break-word;
        }

        .message .timestamp {
            color: #888;
            font-size: 16px;
        }

        .message.system {
            color: #888;
            font-style: italic;
        }

        .message.private {
            color: #ff6b9d;
        }

        .message .username {
            color: #e5ae73;
            font-weight: bold;
        }

        .embedded-content {
            margin: 10px 0;
            max-width: 100%;
            display: flex;
            justify-content: flex-start;
            overflow: hidden;
        }

        .embedded-content img,
        .embedded-content video {
            max-width: min(500px, 100%);
            max-height: 400px;
            height: auto;
            width: auto;
            border: 1px solid #e5ae73;
            object-fit: contain;
        }

        .embedded-content iframe {
            max-width: min(500px, 100%);
            width: 400px;
            height: 225px;
            border: 1px solid #e5ae73;
        }

        /* Custom HTML tags for messages */
        .message b,
        .message bold {
            font-weight: bold;
        }

        .message big {
            font-size: 1.2em;
        }

        .message center {
            display: block;
            text-align: center;
        }

        .message small {
            font-size: 0.8em;
        }

        .message blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        .message marquee {
            display: block;
            animation: marquee 10s linear infinite;
            white-space: nowrap;
            overflow: hidden;
        }

        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* Input Area */
        .input-container {
            display: flex;
            padding: 10px 20px;
            border-top: 1px solid #e5ae73;
            background: black;
            align-items: flex-end;
            gap: 10px;
            flex-shrink: 0;
            position: relative;
        }

        .message-input {
            flex: 1;
            background: black;
            color: #e5ae73;
            border: 1px solid #e5ae73;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            outline: none;
            resize: none;
            min-height: 40px;
            max-height: 160px;
            overflow-y: auto;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message-input::-webkit-scrollbar {
            width: 8px;
        }

        .message-input::-webkit-scrollbar-track {
            background: black;
        }

        .message-input::-webkit-scrollbar-thumb {
            background: #e5ae73;
        }

        .send-btn {
            background: #e5ae73;
            color: black;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            height: fit-content;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #d19960;
        }

        /* Users Panel */
        .users-panel {
            width: 200px;
            background: black;
            border-left: 2px solid #e5ae73;
            padding: 0;
        }

        .users-header {
            background: #e5ae73;
            color: black;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
        }

        .users-list {
            padding: 10px;
        }

        .user-item {
            padding: 5px;
            font-size: 12px;
            color: #e5ae73;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .user-item:hover {
            background: #333;
        }

        .kick-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 8px;
            margin-left: 5px;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #e5ae73;
            font-size: 11px;
            border-radius: 3px;
        }

        .connected {
            color: #4CAF50;
            border-color: #4CAF50;
        }

        .disconnected {
            color: #f44336;
            border-color: #f44336;
        }

        .connecting {
            color: #ff9800;
            border-color: #ff9800;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
        }

        .welcome-screen h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: black;
            margin: 15% auto;
            padding: 20px;
            border: 2px solid #e5ae73;
            width: 400px;
            max-width: 90%;
        }

        .modal h3 {
            margin-bottom: 15px;
            color: #e5ae73;
        }

        .modal input {
            width: 100%;
            background: black;
            color: #e5ae73;
            border: 1px solid #e5ae73;
            padding: 8px;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }

        .modal-buttons {
            margin-top: 15px;
            text-align: right;
        }

        .modal-btn {
            background: #e5ae73;
            color: black;
            border: none;
            padding: 8px 16px;
            margin-left: 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .modal-btn.cancel {
            background: transparent;
            color: #e5ae73;
            border: 1px solid #e5ae73;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 2000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: #4CAF50;
            color: white;
            border: 1px solid #4CAF50;
        }

        .notification.error {
            background: #f44336;
            color: white;
            border: 1px solid #f44336;
        }

        .debug-info {
            position: fixed;
            bottom: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #e5ae73;
            padding: 5px;
            font-size: 10px;
            color: #e5ae73;
            max-width: 300px;
            z-index: 1500;
        }

        .hidden {
            display: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: black;
        }

        ::-webkit-scrollbar-thumb {
            background: #e5ae73;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #d19960;
        }

        html::before {
            content: "";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background:
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 9999;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <!-- Debug Info -->
    <div class="debug-info" id="debug-info" style="display: none;">
        <div>Socket: <span id="socket-state">Not connected</span></div>
        <div>User ID: <span id="debug-user-id">-</span></div>
        <div>Server ID: <span id="debug-server-id">-</span></div>
        <div>Room ID: <span id="debug-room-id">-</span></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-small">TERMINET.IRC</div>
        <div class="tagline">if it worked, it's a miracle.</div>
        <div class="user-info">
            <div>User: <span id="current-username">Loading...</span></div>
            <div>@ <span id="current-room">#general</span></div>
        </div>

        <button class="sidebar-btn" onclick="showCreateServerModal()">+ Create Server</button>

        <div class="servers-section">
            <div class="servers-header">My Servers</div>
            <div id="servers-list">
                <div style="opacity: 0.5; font-size: 12px; padding: 10px; text-align: center;">Loading...</div>
            </div>
        </div>

        <button class="sidebar-btn" onclick="showJoinServerModal()">+ Join Server</button>
        <button class="sidebar-btn" onclick="showCreateRoomModal()" id="create-room-btn" style="display: none;">+ Create
            Room</button>
        <button class="sidebar-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div id="welcome-screen" class="welcome-screen">
            <h2>Welcome to Terminet IRC!</h2>
            <p>Create or join a server to start chatting.</p>
            <br>
            <div style="font-size: 12px; opacity: 0.7;">
                <div>Server Status: <span id="server-status">Checking...</span></div>
                <div>Database: <span id="db-status">Unknown</span></div>
                <div>Logs: <span id="logs-status">Unknown</span></div>
            </div>
        </div>

        <div id="chat-container" style="display: none; flex-direction: column; height: 100%;">
            <div class="chat-header">
                <span id="chat-title">#general</span>
                <div class="header-actions">
                    <button class="header-btn" onclick="showNickModal()">Change Nick</button>
                    <button class="header-btn" onclick="loadRoomLogs()">Load Logs</button>
                    <span id="server-actions"></span>
                </div>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="input-container">
                <textarea id="message-input" class="message-input" placeholder="Type message... (/help for commands)"
                    maxlength="1000" rows="1"></textarea>
                <button class="send-btn" onclick="sendMessage()">SEND</button>
            </div>
        </div>
    </div>

    <!-- Users Panel -->
    <div class="users-panel" id="users-panel" style="display: none;">
        <div class="users-header">Users Online</div>
        <div class="users-list" id="users-list"></div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status connecting" id="connection-status">
        <span id="status-text">Connecting...</span>
    </div>

    <!-- Modals -->
    <div id="create-server-modal" class="modal">
        <div class="modal-content">
            <h3>Create Server</h3>
            <input type="text" id="server-name" placeholder="Server Name" maxlength="100">
            <input type="text" id="server-description" placeholder="Description (optional)" maxlength="200">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('create-server-modal')">Cancel</button>
                <button class="modal-btn" onclick="createServer()">Create</button>
            </div>
        </div>
    </div>

    <div id="join-server-modal" class="modal">
        <div class="modal-content">
            <h3>Join Server</h3>
            <input type="text" id="join-server-code" placeholder="Server Code" maxlength="8"
                style="text-transform: uppercase;">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('join-server-modal')">Cancel</button>
                <button class="modal-btn" onclick="joinServer()">Join</button>
            </div>
        </div>
    </div>

    <div id="create-room-modal" class="modal">
        <div class="modal-content">
            <h3>Create Room</h3>
            <input type="text" id="room-name" placeholder="Room Name" maxlength="50">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('create-room-modal')">Cancel</button>
                <button class="modal-btn" onclick="createRoom()">Create</button>
            </div>
        </div>
    </div>

    <div id="nick-modal" class="modal">
        <div class="modal-content">
            <h3>Change Nickname</h3>
            <input type="text" id="new-nickname" placeholder="New Nickname" maxlength="20">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('nick-modal')">Cancel</button>
                <button class="modal-btn" onclick="changeNickname()">Change</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-title">Confirm Action</h3>
            <p id="confirm-message">Are you sure?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal('confirm-modal')">Cancel</button>
                <button class="modal-btn" id="confirm-action" onclick="">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <script>
        let socket;
        let currentUser = null;
        let currentServer = null;
        let currentRoom = null;
        let isOwner = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let debugMode = false;
        let roomUsers = new Set();

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing...');
            const userData = sessionStorage.getItem('terminet_user');
            if (!userData) {
                console.log('No user data found, redirecting to login');
                window.location.href = '/';
                return;
            }

            currentUser = JSON.parse(userData);
            document.getElementById('current-username').textContent = currentUser.username;
            updateDebugInfo();

            checkServerHealth();

            setTimeout(() => {
                initializeSocket();
                setupInputHandlers();
            }, 1000);
        });

        function setupInputHandlers() {
            const messageInput = document.getElementById('message-input');

            messageInput.addEventListener('input', function () {
                autoResizeTextarea(this);
            });

            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            document.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    const activeModal = document.querySelector('.modal[style*="block"]');
                    if (activeModal) {
                        const confirmBtn = activeModal.querySelector('.modal-btn:not(.cancel)');
                        if (confirmBtn) {
                            confirmBtn.click();
                        }
                    }
                }
            });
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            const lineHeight = 22;
            const padding = 20;
            const maxLines = 4;
            const minLines = 1;
            const scrollHeight = textarea.scrollHeight;
            const currentLines = Math.floor((scrollHeight - padding) / lineHeight);

            if (currentLines <= maxLines) {
                textarea.style.height = Math.max(scrollHeight, lineHeight * minLines + padding) + 'px';
                textarea.style.overflowY = 'hidden';
            } else {
                textarea.style.height = (lineHeight * maxLines + padding) + 'px';
                textarea.style.overflowY = 'auto';
            }
        }

        function checkServerHealth() {
            console.log('Checking server health...');
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    console.log('Health check response:', data);
                    document.getElementById('server-status').textContent = data.status;
                    document.getElementById('db-status').textContent = data.database;
                    document.getElementById('logs-status').textContent = data.logs_dir ? 'Ready' : 'Not configured';
                })
                .catch(error => {
                    console.error('Health check failed:', error);
                    document.getElementById('server-status').textContent = 'Error';
                    document.getElementById('db-status').textContent = 'Error';
                    document.getElementById('logs-status').textContent = 'Error';
                });
        }

        function updateDebugInfo() {
            if (debugMode) {
                document.getElementById('debug-user-id').textContent = currentUser?.user_id || '-';
                document.getElementById('debug-server-id').textContent = currentServer?.id || '-';
                document.getElementById('debug-room-id').textContent = currentRoom || '-';
                document.getElementById('socket-state').textContent = socket?.connected ? 'Connected' : 'Disconnected';
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugMode ? 'block' : 'none';
            if (debugMode) {
                updateDebugInfo();
            }
        }

        function initializeSocket() {
            console.log('Initializing socket connection...');
            updateConnectionStatus('connecting');

            if (socket) {
                socket.disconnect();
            }

            socket = io(window.location.origin, {
                transports: ['polling', 'websocket'],
                upgrade: true,
                timeout: 30000,
                forceNew: true,
                reconnection: true,
                reconnectionAttempts: maxReconnectAttempts,
                reconnectionDelay: 2000
            });

            socket.on('connect', function () {
                console.log('Socket connected successfully:', socket.id);
                updateConnectionStatus('connected');
                reconnectAttempts = 0;
                updateDebugInfo();
                setTimeout(loadUserServers, 500);
            });

            socket.on('disconnect', function (reason) {
                console.log('Socket disconnected:', reason);
                updateConnectionStatus('disconnected');
                updateDebugInfo();

                if (reason === 'io server disconnect') {
                    setTimeout(initializeSocket, 2000);
                }
            });

            socket.on('connect_error', function (error) {
                console.error('Socket connection error:', error);
                reconnectAttempts++;
                updateConnectionStatus('disconnected');

                if (reconnectAttempts >= maxReconnectAttempts) {
                    showNotification('Connection failed. Please refresh the page.', 'error');
                }
            });

            socket.on('connection_confirmed', function (data) {
                console.log('Connection confirmed:', data);
                showNotification('Connected to Terminet IRC', 'success');
            });

            // Server events
            socket.on('servers_list', function (data) {
                console.log('Received servers list:', data);
                renderServersList(data.owned_servers || [], data.joined_servers || []);
            });

            socket.on('server_created', function (data) {
                console.log('Server created:', data);
                if (data.success) {
                    showNotification('Server created successfully!', 'success');
                    closeModal('create-server-modal');
                    loadUserServers();
                } else {
                    showNotification('Failed to create server: ' + data.error, 'error');
                }
            });

            socket.on('server_joined', function (data) {
                console.log('Server joined:', data);
                if (data.success) {
                    showNotification('Joined server successfully!', 'success');
                    closeModal('join-server-modal');
                    loadUserServers();
                } else {
                    showNotification('Failed to join server: ' + data.error, 'error');
                }
            });

            socket.on('server_data', function (data) {
                console.log('Received server data:', data);
                if (data.success) {
                    currentServer = data.server;
                    isOwner = currentServer.owner_id === currentUser.user_id;
                    renderServerData(data.server, data.rooms);
                    updateDebugInfo();

                    const generalRoom = data.rooms.find(room => room.name === 'general');
                    if (generalRoom) {
                        joinRoom(generalRoom.id, generalRoom.name);
                    }
                } else {
                    showNotification('Failed to load server: ' + data.error, 'error');
                }
            });

            socket.on('server_deleted', function (data) {
                console.log('Server deleted:', data);
                if (data.success) {
                    showNotification('Server deleted successfully', 'success');
                    loadUserServers();
                    if (currentServer) {
                        currentServer = null;
                        currentRoom = null;
                        showWelcomeScreen();
                    }
                } else {
                    showNotification('Failed to delete server: ' + data.error, 'error');
                }
            });

            socket.on('server_left', function (data) {
                console.log('Server left:', data);
                if (data.success) {
                    showNotification('Successfully left server', 'success');
                    currentServer = null;
                    currentRoom = null;
                    showWelcomeScreen();
                    setTimeout(() => {
                        loadUserServers();
                    }, 500);
                } else {
                    showNotification('Failed to leave server: ' + data.error, 'error');
                }
            });

            // Room events
            socket.on('room_joined', function (data) {
                console.log('Room joined:', data);
                currentRoom = data.room_id;
                document.getElementById('current-room').textContent = '#' + data.room_name;
                document.getElementById('chat-title').textContent = '#' + data.room_name;
                updateDebugInfo();

                roomUsers.clear();
                showChatContainer();
                renderMessages(data.messages || []);
            });

            socket.on('room_created', function (data) {
                console.log('Room created:', data);
                if (data.success) {
                    showNotification('Room created successfully!', 'success');
                    closeModal('create-room-modal');
                    if (currentServer) {
                        loadServerData(currentServer.id);
                    }
                } else {
                    showNotification('Failed to create room: ' + data.error, 'error');
                }
            });

            socket.on('room_deleted', function (data) {
                console.log('Room deleted:', data);
                if (data.success) {
                    showNotification('Room deleted successfully', 'success');
                    if (currentServer) {
                        loadServerData(currentServer.id);
                    }
                } else {
                    showNotification('Failed to delete room: ' + data.error, 'error');
                }
            });

            socket.on('room_logs', function (data) {
                console.log('Room logs:', data);
                if (data.success) {
                    renderMessages(data.messages || []);
                    showNotification(`Loaded ${data.messages.length} messages from logs`, 'success');
                } else {
                    showNotification('Failed to load logs: ' + data.error, 'error');
                }
            });

            // Message events
            socket.on('new_message', function (data) {
                console.log('New message:', data);
                addMessage(data);
            });

            socket.on('system_message', function (data) {
                console.log('System message received:', data);
                addMessage(data);
            });

            socket.on('users_list', function (data) {
                console.log('Users list received:', data.users);

                roomUsers = new Set(data.users || []);
                renderUsersList(Array.from(roomUsers));
            });

            socket.on('room_error', function (data) {
                console.error('Room error:', data);
                showNotification('Room error: ' + data.error, 'error');
            });

            socket.on('message_error', function (data) {
                console.error('Message error:', data);
                showNotification('Message error: ' + data.error, 'error');
            });

            socket.on('error', function (error) {
                console.error('Socket error:', error);
                showNotification('Connection error occurred', 'error');
            });

            // Kick handlers
            socket.on('kicked_from_server_reload', function (data) {
                console.log('Kicked from server with reload instruction:', data);
                showNotification(data.message, 'error');

                currentServer = null;
                currentRoom = null;
                roomUsers.clear();

                alert(`${data.message}\n\nYou will be redirected to the main screen.`);
                showWelcomeScreen();

                setTimeout(() => {
                    loadUserServers();
                }, 1000);
            });

            socket.on('kicked_from_server', function (data) {
                console.log('Kicked from server (fallback):', data);
                showNotification('You have been kicked from this server!', 'error');

                currentServer = null;
                currentRoom = null;
                roomUsers.clear();

                showWelcomeScreen();
                setTimeout(() => {
                    loadUserServers();
                }, 1000);
            });
            socket.on('users_list', function (data) {
                console.log('Users list:', data);
                renderUsersList(data.users || []);
            });

            socket.on('kick_result', function (data) {
                console.log('Kick result:', data);
                if (data.success) {
                    showNotification(data.message, 'success');
                } else {
                    showNotification('Kick failed: ' + data.error, 'error');
                }
            });
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            const textEl = document.getElementById('status-text');

            statusEl.className = `connection-status ${status}`;

            switch (status) {
                case 'connected':
                    textEl.textContent = 'Connected';
                    break;
                case 'connecting':
                    textEl.textContent = 'Connecting...';
                    break;
                case 'disconnected':
                    textEl.textContent = 'Disconnected';
                    break;
            }
        }

        function loadUserServers() {
            console.log('Loading user servers...');
            if (socket && socket.connected && currentUser) {
                socket.emit('get_user_servers', {
                    user_id: currentUser.user_id
                });
            } else {
                console.error('Cannot load servers: socket not connected or no user');
                setTimeout(loadUserServers, 2000);
            }
        }

        function loadRoomLogs() {
            if (!currentUser || !currentServer || !currentRoom) {
                showNotification('No room selected', 'error');
                return;
            }

            console.log('Loading room logs...');
            socket.emit('get_room_logs', {
                user_id: currentUser.user_id,
                server_id: currentServer.id,
                room_id: currentRoom,
                room_name: document.getElementById('chat-title').textContent.replace('#', ''),
                limit: 100
            });
        }

        function renderServersList(ownedServers, joinedServers) {
            console.log('Rendering servers list:', ownedServers, joinedServers);
            const serversList = document.getElementById('servers-list');
            serversList.innerHTML = '';

            if (ownedServers.length === 0 && joinedServers.length === 0) {
                serversList.innerHTML = '<div style="opacity: 0.5; font-size: 12px; padding: 10px; text-align: center;">No servers found</div>';
                return;
            }

            // Render owned servers
            ownedServers.forEach(server => {
                const serverEl = document.createElement('div');
                serverEl.className = 'server-item';
                serverEl.innerHTML = `
                    <strong>${server.name}</strong><br>
                    <small>Code: ${server.code} (Owner)</small>
                    <div class="server-actions">
                        <button class="action-btn delete" onclick="confirmDeleteServer(${server.id}, '${server.name}')">DEL</button>
                    </div>
                `;
                serverEl.onclick = (e) => {
                    if (e.target.classList.contains('action-btn')) return;
                    selectServer(server, serverEl);
                };
                serversList.appendChild(serverEl);
            });

            // Render joined servers
            joinedServers.forEach(server => {
                const serverEl = document.createElement('div');
                serverEl.className = 'server-item';
                serverEl.innerHTML = `
                    <strong>${server.name}</strong><br>
                    <small>Code: ${server.code}</small>
                    <div class="server-actions">
                        <button class="action-btn leave" onclick="confirmLeaveServer(${server.id}, '${server.name}')">LEAVE</button>
                    </div>
                `;
                serverEl.onclick = (e) => {
                    if (e.target.classList.contains('action-btn')) return;
                    selectServer(server, serverEl);
                };
                serversList.appendChild(serverEl);
            });
        }

        function selectServer(server, element) {
            console.log('Selecting server:', server);
            document.querySelectorAll('.server-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            loadServerData(server.id);
        }

        function loadServerData(serverId) {
            console.log('Loading server data for:', serverId);
            if (socket && socket.connected) {
                socket.emit('get_server_data', {
                    server_id: serverId,
                    user_id: currentUser.user_id
                });
            }
        }

        function renderServerData(server, rooms) {
            console.log('Rendering server data:', server, rooms);
            const createRoomBtn = document.getElementById('create-room-btn');
            if (server.owner_id === currentUser.user_id) {
                createRoomBtn.style.display = 'block';
            } else {
                createRoomBtn.style.display = 'none';
            }

            // Remove existing rooms container
            const existingRooms = document.querySelector('.rooms-container');
            if (existingRooms) {
                existingRooms.remove();
            }

            const serversList = document.getElementById('servers-list');
            const roomsContainer = document.createElement('div');
            roomsContainer.className = 'rooms-container';
            roomsContainer.innerHTML = '<div style="padding: 5px 10px; font-weight: bold; font-size: 12px; color: #e5ae73; border-top: 1px solid #666; margin-top: 10px;">Rooms:</div>';

            rooms.forEach(room => {
                const roomEl = document.createElement('div');
                roomEl.className = 'room-item';

                let roomActions = '';
                if (server.owner_id === currentUser.user_id && room.name !== 'general') {
                    roomActions = `<div class="room-actions">
                        <button class="action-btn delete" onclick="confirmDeleteRoom(${room.id}, '${room.name}')">DEL</button>
                    </div>`;
                }

                roomEl.innerHTML = `#${room.name}${roomActions}`;
                roomEl.onclick = (e) => {
                    if (e.target.classList.contains('action-btn')) return;
                    document.querySelectorAll('.room-item').forEach(el => el.classList.remove('active'));
                    roomEl.classList.add('active');
                    joinRoom(room.id, room.name);
                };
                roomsContainer.appendChild(roomEl);
            });

            serversList.appendChild(roomsContainer);
        }

        function joinRoom(roomId, roomName) {
            console.log('Joining room:', roomId, roomName);

            if (socket && socket.connected) {
                socket.emit('join_room', {
                    room_id: roomId,
                    user_id: currentUser.user_id,
                    username: currentUser.username
                });
            }
        }

        function showChatContainer() {
            const welcomeScreen = document.getElementById('welcome-screen');
            const chatContainer = document.getElementById('chat-container');
            const usersPanel = document.getElementById('users-panel');

            welcomeScreen.style.display = 'none';
            chatContainer.style.display = 'flex';
            chatContainer.style.flexDirection = 'column';
            chatContainer.style.height = '100%';
            usersPanel.style.display = 'block';
        }

        function showWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcome-screen');
            const chatContainer = document.getElementById('chat-container');
            const usersPanel = document.getElementById('users-panel');

            welcomeScreen.style.display = 'flex';
            chatContainer.style.display = 'none';
            usersPanel.style.display = 'none';
            document.getElementById('create-room-btn').style.display = 'none';
        }

        function renderMessages(messages) {
            console.log('Rendering messages:', messages.length);
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            roomUsers.clear();

            messages.forEach(msg => {
                addMessage(msg);
            });

            scrollToBottom();
        }

        function addMessage(data) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${data.type}`;

            if (data.username && data.type !== 'system') {
                roomUsers.add(data.username);
            }

            let content = '';
            if (data.type === 'system') {
                content = `<span class="timestamp">[${data.timestamp}]</span> <em>*** ${data.message}</em>`;
            } else if (data.type === 'private') {
                const processedMessage = processMessage(data.message);
                content = `<span class="timestamp">[${data.timestamp}]</span> <span style="color: #ff6b9d;">[PRIVATE]</span> <span class="username">&lt;${data.username}&gt;</span> ${processedMessage}`;
            } else {
                const processedMessage = processMessage(data.message);
                content = `<span class="timestamp">[${data.timestamp}]</span> <span class="username">&lt;${data.username}&gt;</span> ${processedMessage}`;
            }

            messageEl.innerHTML = content;
            messagesContainer.appendChild(messageEl);
            scrollToBottom();
        }

        function processMessage(message) {
            // Process HTML tags first
            let processedMsg = processHtmlTags(message);

            // Auto-embed images and GIFs
            if (message.startsWith('/gif ') || message.startsWith('/img ')) {
                const url = message.substring(5).trim();
                if (isValidImageUrl(url)) {
                    return `<div class="embedded-content"><img src="${url}" alt="Image" onerror="this.style.display='none'" loading="lazy"></div>`;
                }
                return processedMsg;
            }

            // Auto-embed videos
            if (message.startsWith('/video ')) {
                const url = message.substring(7).trim();
                if (isYouTubeUrl(url)) {
                    const videoId = extractYouTubeId(url);
                    return `<div class="embedded-content"><iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe></div>`;
                } else if (isValidVideoUrl(url)) {
                    return `<div class="embedded-content"><video controls><source src="${url}"></video></div>`;
                }
                return processedMsg;
            }

            // Check for direct image/video URLs
            const urlMatch = message.match(/https?:\/\/[^\s]+/g);
            if (urlMatch) {
                urlMatch.forEach(url => {
                    if (isValidImageUrl(url)) {
                        processedMsg = processedMsg.replace(url,
                            `${url}<div class="embedded-content"><img src="${url}" alt="Image" onerror="this.style.display='none'" loading="lazy"></div>`
                        );
                    } else if (isYouTubeUrl(url)) {
                        const videoId = extractYouTubeId(url);
                        processedMsg = processedMsg.replace(url,
                            `${url}<div class="embedded-content"><iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe></div>`
                        );
                    } else if (isValidVideoUrl(url)) {
                        processedMsg = processedMsg.replace(url,
                            `${url}<div class="embedded-content"><video controls><source src="${url}"></video></div>`
                        );
                    }
                });
            }

            return processedMsg;
        }

        function processHtmlTags(message) {
            // Process HTML tags while escaping dangerous content
            let processedMsg = message;

            // Handle <size> tag with validation
            processedMsg = processedMsg.replace(/<size=(\d+)>(.*?)<\/size>/gi, function (match, size, content) {
                const fontSize = Math.max(6, Math.min(48, parseInt(size) || 16));
                return `<span style="font-size: ${fontSize}px;">${content}</span>`;
            });

            // Handle other formatting tags
            processedMsg = processedMsg.replace(/<b>(.*?)<\/b>/gi, '<b>$1</b>');
            processedMsg = processedMsg.replace(/<bold>(.*?)<\/bold>/gi, '<bold>$1</bold>');
            processedMsg = processedMsg.replace(/<big>(.*?)<\/big>/gi, '<big>$1</big>');
            processedMsg = processedMsg.replace(/<center>(.*?)<\/center>/gi, '<center>$1</center>');
            processedMsg = processedMsg.replace(/<small>(.*?)<\/small>/gi, '<small>$1</small>');
            processedMsg = processedMsg.replace(/<blink>(.*?)<\/blink>/gi, '<blink>$1</blink>');
            processedMsg = processedMsg.replace(/<marquee>(.*?)<\/marquee>/gi, '<marquee>$1</marquee>');

            // Escape other potentially dangerous HTML
            const tempDiv = document.createElement('div');
            const allowedTags = ['b', 'bold', 'big', 'center', 'small', 'blink', 'marquee', 'span'];

            // Create a safe version by only allowing specific tags
            let safeMsg = '';
            let inTag = false;
            let currentTag = '';

            for (let i = 0; i < processedMsg.length; i++) {
                const char = processedMsg[i];

                if (char === '<') {
                    inTag = true;
                    currentTag = '';
                    safeMsg += char;
                } else if (char === '>') {
                    inTag = false;
                    safeMsg += char;
                } else if (inTag) {
                    currentTag += char;
                    safeMsg += char;
                } else {
                    // Escape dangerous characters outside of allowed tags
                    if (char === '&') {
                        safeMsg += '&amp;';
                    } else if (char === '"') {
                        safeMsg += '&quot;';
                    } else if (char === "'") {
                        safeMsg += '&#x27;';
                    } else {
                        safeMsg += char;
                    }
                }
            }

            return safeMsg;
        }
        function parseUrlSafe(raw) {
            try { return new URL(raw); } catch { return null; }
        }

        function hasExt(pathname, exts) {
            const p = (pathname || '').toLowerCase();
            return exts.some(ext => p.endsWith('.' + ext));
        }

        function isDiscordHost(host) {
            // Common Discord media/attachment hosts
            const h = (host || '').toLowerCase();
            return h.endsWith('discordapp.com') ||
                h.endsWith('discord.com') ||
                h.endsWith('media.discordapp.net') ||
                h === 'cdn.discordapp.com';
        }
        function isValidImageUrl(url) {
            const u = parseUrlSafe(url);
            if (!u || (u.protocol !== 'http:' && u.protocol !== 'https:')) return false;

            // Accept standard image extensions based on pathname (ignores ?query)
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'];
            if (hasExt(u.pathname, imageExts)) return true;

            // Discord special-case: `format=webp` or similar in query, or known image CDN
            if (isDiscordHost(u.host)) {
                const fmt = (u.searchParams.get('format') || '').toLowerCase();
                if (fmt && imageExts.includes(fmt)) return true;
                // Many Discord image links include proper extensions already, handled above.
                return true; // Be lenient for Discord CDN images
            }

            return false;
        }


        function isValidVideoUrl(url) {
            const u = parseUrlSafe(url);
            if (!u || (u.protocol !== 'http:' && u.protocol !== 'https:')) return false;

            const videoExts = ['mp4', 'webm', 'ogg', 'avi', 'mov', 'm4v'];
            if (hasExt(u.pathname, videoExts)) return true;

            // Discord attachments often have extension before query; also allow trusted hosts
            if (isDiscordHost(u.host)) return true;

            return false;
        }

        function isYouTubeUrl(url) {
            return /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/.test(url);
        }

        function extractYouTubeId(url) {
            const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            return match ? match[1] : '';
        }

        function renderUsersList(users) {
            console.log('Rendering users list:', users);
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';

            // Remove duplicates and sort
            const uniqueUsers = [...new Set(users)].sort();

            uniqueUsers.forEach(user => {
                const userEl = document.createElement('div');
                userEl.className = 'user-item';

                if (isOwner && user !== currentUser.username) {
                    userEl.innerHTML = `
                <span>${user}</span>
                <button class="kick-btn" onclick="kickUser('${user}')">KICK</button>
            `;
                } else {
                    userEl.textContent = user;
                }

                usersList.appendChild(userEl);
            });
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message || !currentRoom) return;

            console.log('Sending message:', message);

            // Handle commands
            if (message === '/help') {
                showHelpMessage();
                input.value = '';
                autoResizeTextarea(input);
                return;
            }

            if (message.startsWith('/nick ')) {
                const newNick = message.substring(6).trim();
                if (newNick) {
                    changeNicknameDirect(newNick);
                } else {
                    showNotification('Usage: /nick <new_nickname>', 'error');
                }
                input.value = '';
                autoResizeTextarea(input);
                return;
            }

            if (message === '/logs') {
                loadRoomLogs();
                input.value = '';
                autoResizeTextarea(input);
                return;
            }

            if (message === '/clear') {
                document.getElementById('chat-messages').innerHTML = '';
                roomUsers.clear();
                input.value = '';
                autoResizeTextarea(input);
                return;
            }

            // Send regular message
            if (socket && socket.connected) {
                socket.emit('send_message', {
                    message: message,
                    user_id: currentUser.user_id,
                    username: currentUser.username,
                    room_id: currentRoom
                });
            } else {
                showNotification('Not connected to server', 'error');
            }

            input.value = '';
            autoResizeTextarea(input);
        }

        function showHelpMessage() {
            const helpText = `*** TERMINET IRC COMMANDS ***
/help - Show this help message
/nick <nickname> - Change your nickname
/gif <url> - Embed image/GIF
/img <url> - Embed image
/video <url> - Embed video (supports YouTube)
/logs - Load room chat logs
/clear - Clear chat messages

*** FORMATTING TAGS ***
<b>text</b> or <bold>text</bold> - Bold text
<big>text</big> - Larger text
<small>text</small> - Smaller text
<center>text</center> - Centered text
<blink>text</blink> - Blinking text
<marquee>text</marquee> - Scrolling text
<size=12>text</size> - Custom font size (6-48px)

*** MEDIA EMBEDDING ***
- Supported image formats: JPG, JPEG, PNG, GIF, WEBP, BMP, SVG
- Supported video formats: MP4, WEBM, OGG, AVI, MOV
- YouTube videos are automatically embedded
- All URLs must start with http:// or https://
- Media will auto-resize to fit chat area

*** SERVER MANAGEMENT ***
- Owners can create/delete rooms and kick users
- Members can leave servers (except owned servers)
- All messages are logged per-user basis
- Max 512 messages per room log file`;

            const helpMsg = {
                type: 'system',
                // Escape so tags display literally in chat
                message: escapeHtml(helpText),
                timestamp: new Date().toLocaleTimeString().substring(0, 8)
            };
            addMessage(helpMsg);
        }
        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }
        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.getElementById(modalId).querySelectorAll('input').forEach(input => {
                input.value = '';
            });
        }

        function showCreateServerModal() {
            showModal('create-server-modal');
            setTimeout(() => document.getElementById('server-name').focus(), 100);
        }

        function showJoinServerModal() {
            showModal('join-server-modal');
            setTimeout(() => document.getElementById('join-server-code').focus(), 100);
        }

        function showCreateRoomModal() {
            if (!currentServer) {
                showNotification('Please select a server first', 'error');
                return;
            }
            showModal('create-room-modal');
            setTimeout(() => document.getElementById('room-name').focus(), 100);
        }

        function showNickModal() {
            document.getElementById('new-nickname').value = currentUser.username;
            showModal('nick-modal');
            setTimeout(() => {
                const input = document.getElementById('new-nickname');
                input.focus();
                input.select();
            }, 100);
        }

        function createServer() {
            const name = document.getElementById('server-name').value.trim();
            const description = document.getElementById('server-description').value.trim();

            if (!name) {
                showNotification('Server name is required', 'error');
                return;
            }

            console.log('Creating server:', name);
            if (socket && socket.connected) {
                socket.emit('create_server', {
                    name: name,
                    description: description,
                    owner_id: currentUser.user_id
                });
            } else {
                showNotification('Not connected to server', 'error');
            }
        }

        function joinServer() {
            const code = document.getElementById('join-server-code').value.trim().toUpperCase();

            if (!code) {
                showNotification('Server code is required', 'error');
                return;
            }

            console.log('Joining server:', code);
            if (socket && socket.connected) {
                socket.emit('join_server', {
                    server_code: code,
                    user_id: currentUser.user_id
                });
            } else {
                showNotification('Not connected to server', 'error');
            }
        }

        function createRoom() {
            const roomName = document.getElementById('room-name').value.trim();

            if (!roomName) {
                showNotification('Room name is required', 'error');
                return;
            }

            if (!currentServer) {
                showNotification('No server selected', 'error');
                return;
            }

            console.log('Creating room:', roomName);
            if (socket && socket.connected) {
                socket.emit('create_room', {
                    room_name: roomName,
                    server_id: currentServer.id,
                    user_id: currentUser.user_id
                });
            } else {
                showNotification('Not connected to server', 'error');
            }
        }

        function changeNickname() {
            const newNick = document.getElementById('new-nickname').value.trim();
            if (!newNick) {
                showNotification('Nickname cannot be empty', 'error');
                return;
            }
            changeNicknameDirect(newNick);
        }

        function changeNicknameDirect(newNickname) {
            if (newNickname === currentUser.username) {
                showNotification('That is already your nickname', 'error');
                return;
            }

            if (newNickname.length > 20) {
                showNotification('Nickname must be 20 characters or less', 'error');
                return;
            }

            console.log('Changing nickname to:', newNickname);

            if (socket && socket.connected && currentRoom) {
                socket.emit('change_nickname', {
                    user_id: currentUser.user_id,
                    new_nick: newNickname,
                    room_id: currentRoom
                });
            } else {
                showNotification('Not connected to server or no room selected', 'error');
            }
        }

        // Add these new socket event handlers in the initialization section:

        socket.on('nickname_changed', function (data) {
            console.log('Nickname changed successfully:', data);
            if (data.success) {
                const oldNick = currentUser.username;
                currentUser.username = data.new_nick;
                document.getElementById('current-username').textContent = data.new_nick;
                sessionStorage.setItem('terminet_user', JSON.stringify(currentUser));
                showNotification('Nickname changed successfully!', 'success');
                closeModal('nick-modal');
            }
        });

        socket.on('nickname_error', function (data) {
            console.error('Nickname change error:', data);
            showNotification('Nickname change failed: ' + data.error, 'error');
        });

        // Also update the users_list handler to properly update the roomUsers set:

        socket.on('users_list', function (data) {
            console.log('Users list:', data);
            roomUsers = new Set(data.users || []);
            renderUsersList(Array.from(roomUsers));
        });

        function confirmDeleteServer(serverId, serverName) {
            showConfirmModal(
                'Delete Server',
                `Are you sure you want to delete the server "${serverName}"? This action cannot be undone.`,
                () => deleteServer(serverId)
            );
        }

        function confirmLeaveServer(serverId, serverName) {
            showConfirmModal(
                'Leave Server',
                `Are you sure you want to leave the server "${serverName}"?`,
                () => leaveServer(serverId)
            );
        }

        function confirmDeleteRoom(roomId, roomName) {
            showConfirmModal(
                'Delete Room',
                `Are you sure you want to delete the room "#${roomName}"?`,
                () => deleteRoom(roomId)
            );
        }

        function deleteServer(serverId) {
            console.log('Deleting server:', serverId);
            if (socket && socket.connected) {
                socket.emit('delete_server', {
                    server_id: serverId,
                    user_id: currentUser.user_id
                });
            }
            closeModal('confirm-modal');
        }

        function leaveServer(serverId) {
            console.log('Leaving server:', serverId);
            if (socket && socket.connected) {
                socket.emit('leave_server', {
                    server_id: serverId,
                    user_id: currentUser.user_id
                });
            }
            closeModal('confirm-modal');
        }

        function deleteRoom(roomId) {
            console.log('Deleting room:', roomId);
            if (socket && socket.connected) {
                socket.emit('delete_room', {
                    room_id: roomId,
                    user_id: currentUser.user_id
                });
            }
            closeModal('confirm-modal');
        }

        function kickUser(username) {
            if (!currentRoom || !isOwner) {
                showNotification('Only server owners can kick users', 'error');
                return;
            }

            if (username === currentUser.username) {
                showNotification('You cannot kick yourself', 'error');
                return;
            }

            console.log('Kicking user:', username);

            if (!confirm(`Are you sure you want to kick ${username} from this server?\n\nThis will completely remove them from the server.`)) {
                return;
            }

            if (socket && socket.connected) {
                socket.emit('kick_user', {
                    server_id: currentServer.id,
                    username: username,
                    kicked_by: currentUser.user_id
                });
            }

            roomUsers.delete(username);
            renderUsersList(Array.from(roomUsers));
        }

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-action').onclick = onConfirm;
            showModal('confirm-modal');
        }

        function showNotification(message, type = 'success') {
            console.log('Notification:', message, type);
            const existing = document.querySelectorAll('.notification');
            existing.forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function logout() {
            console.log('Logging out...');
            sessionStorage.removeItem('terminet_user');
            if (socket) {
                socket.disconnect();
            }
            window.location.href = '/';
        }

        // Handle connection errors and cleanup
        window.addEventListener('beforeunload', function () {
            if (socket) {
                socket.disconnect();
            }
        });

        // Click outside modal to close
        window.addEventListener('click', function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // Auto-reconnect function
        function attemptReconnect() {
            if (!socket || !socket.connected) {
                console.log('Attempting to reconnect...');
                initializeSocket();
            }
        }

        // Check connection every 10 seconds
        setInterval(() => {
            if (socket && !socket.connected && reconnectAttempts < maxReconnectAttempts) {
                attemptReconnect();
            }
            updateDebugInfo();
        }, 10000);

    </script>
</body>

</html>
